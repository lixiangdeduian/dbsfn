## 医院管理系统数据库设计计划（ex8）

### 0. 目标与交付物

- 产出完整数据库结构设计：所有表、所有字段、主外键、唯一/检查约束、索引建议
- 产出完整触发器设计：给出可执行的触发器定义（含触发时机、逻辑与错误处理）
- 产出角色/权限/视图设计：明确每个角色权限清单；每个视图的来源表与字段列表
- 最终交付：一份可直接执行的建库脚本（建议按 `schema.sql` / `triggers.sql` / `security.sql` 拆分）

### 1. 需求边界确认（先定范围，避免“全能系统”）

- 业务主线：门诊挂号/就诊、住院管理、医嘱/处方、检验检查、收费结算、药品与库存（可选）
- 对象范围：患者、医护人员、科室、号源/排班、病历/诊断、处方与用药、检验、费用与支付
- 数据治理：审计字段（创建人/时间、更新人/时间）、软删除策略（如需要）
- 统一编码：患者号、员工号、科室编码、药品编码、收费项目编码等

### 2. 概念模型（ER）与实体清单

- 核心实体：`Patient`、`Staff`、`Department`、`Appointment/Registration`、`Encounter(就诊)`、`Diagnosis`
- 住院实体：`Admission`、`Ward`、`Bed`、`BedAssignment`
- 医嘱与用药：`Prescription`、`PrescriptionItem`、`Drug`、`DrugInventoryTxn`（库存可选）
- 检验检查：`LabOrder`、`LabItem`、`LabResult`
- 收费结算：`ChargeItem`、`Invoice`、`Payment`（含支付方式/状态）
- 关系定义：1:N、N:M（通过中间表拆分）、强制/可选关系与级联策略

### 3. 逻辑结构设计（表结构与字段细化）

- 为每张表定义：字段名、类型、是否为空、默认值、含义、约束（PK/FK/UQ/CK）
- 统一主键策略：自增 `BIGINT` 或 UUID（根据课程/环境要求选一种并保持一致）
- 关键业务约束落地：
  - 号源/排班不允许时间重叠（或限制同医生同时间段唯一）
  - 床位分配同一时间段不可重复占用
  - 处方明细数量>0、金额>=0、状态流转合法
  - 发票/支付金额一致性与作废/退款规则
- 建议索引：就诊检索、患者历史、医生排班、费用查询、库存流水等高频路径

### 4. 触发器设计（保证一致性与审计）

- 审计触发器：自动维护 `created_at/updated_at`、`created_by/updated_by`（若采用）
- 状态与余额类触发器：
  - 新增/更新支付时，联动更新发票已付金额与支付状态
  - 处方明细变更时，联动更新处方总金额
  - 床位分配插入/更新时，校验时间段冲突并阻止非法写入
  - 库存流水写入时，联动更新药品库存（若启用库存模块）
- 触发器输出：给出完整 `CREATE TRIGGER ...` 定义及异常提示（如 `SIGNAL SQLSTATE` 或等价机制）

### 5. 角色、权限与安全视图设计

- 角色划分（可按课程要求调整）：
  - `admin`：全库管理（DDL/DML/授权）
  - `doctor`：患者就诊/病历/处方/检验开单（只读费用或按需）
  - `nurse`：住院与护理记录、床位分配（不接触财务）
  - `pharmacist`：药品目录与处方调剂、库存
  - `lab_tech`：检验项目维护与结果录入
  - `cashier`：收费开票、收款、退款（不改病历）
  - `reception`：挂号、预约、基础信息维护（受限）
  - `patient`：患者自助（只读自己的基础信息、就诊记录、处方/检验结果、账单与支付状态）
- 权限清单：逐表列出 `SELECT/INSERT/UPDATE/DELETE` 粒度（必要时列级权限）
- 视图策略：对敏感表提供“最小字段视图”，并把权限授予到视图而非基表
  - 例如：医生视图隐藏支付信息；收费员视图隐藏诊断明细；护士视图隐藏身份证号等
- 每个视图输出：视图名、来源表（JOIN 关系）、暴露字段列表、过滤条件（如按科室/本人）

### 6. 脚本化交付与自检

- 文件拆分：`schema.sql`（表/约束/索引）→ `triggers.sql` → `security.sql`（角色/权限/视图）
- 大量初始化数据：`seed.sql`（可重复执行；会清空业务表并生成模拟数据），建议执行顺序：`schema.sql` → `triggers.sql` → `seed.sql` → `security.sql`
- 自检清单：
  - 建表顺序与外键依赖正确
  - 触发器不互相递归/死循环
  - 典型流程可跑通：挂号 → 就诊 → 开处方 → 收费 → 支付 → 发票状态更新
  - 权限验证：各角色只能访问其应访问的对象

### 7. 待确认项（开始建模前必须定）

- 目标数据库：MySQL（已确认；本机客户端版本 `mysql 9.4.0`）
- 主键策略：自增 vs UUID；时间字段精度；字符集/排序规则（若是 MySQL）
- 是否需要：软删除、分院/多院区、多科室会诊、医保结算、库存模块
